#errorCatcher ListErrors
# Kickstart config file generated by Spacewalk Config Management
#
# Profile Label : centos7-1804
# Date Created  : 2018-05-21 06:47:22.876407
#

install
text
#if $varExists('static_network')
$static_network
#else
network --bootproto dhcp
#end if
url --url http://$http_server$media_path
lang us
keyboard fr_CH
zerombr
clearpart --all
bootloader --location mbr
timezone Europe/Paris
auth --enableshadow --passalgo=sha256
rootpw --iscrypted $5$.sSZm5IGjX7ANauU$iKkcdgM5UR4JDVMI0JHQYyJ962qQbrDxit1X9N8H99C
selinux --enforcing
reboot
firewall --disabled
skipx
repo --name=centos-7-extras-x86_64-1804 --baseurl=http://$http_server/ks/dist/child/centos-7-extras-x86_64-1804/centos-7-x86_64-1804
repo --name=centos-7-updates-x86_64-1804 --baseurl=http://$http_server/ks/dist/child/centos-7-updates-x86_64-1804/centos-7-x86_64-1804
zerombr
clearpart --all --initlabel
part /biosboot --fstype biosboot --size=1 --asprimary
part /boot --fstype xfs --size 1024 --asprimary
part pv.10 --ondisk sda --grow
volgroup rootvg pv.10
logvol swap --recommended --name=swap --vgname=rootvg --grow
logvol / --fstype=xfs --name=root --vgname=rootvg --size=10240
logvol /var  --fstype=xfs --name=var --vgname=rootvg --size=4096
logvol /var/log  --fstype=xfs --name=varlog --vgname=rootvg --size=4096
logvol /var/log/audit	--fstype=xfs  --name=audit --vgname=rootvg --size=4096
logvol /var/tmp  --fstype=xfs --name=vartmp --vgname=rootvg --size=4096
logvol /tmp  --fstype=xfs --name=tmp --vgname=rootvg --size=4096
logvol /home  --fstype=xfs --name=home --vgname=rootvg --size=4096

%packages  --ignoremissing
@Base
perl
wget
rhn-setup
rhn-check
rhn-client-tools
yum-utils
yum-rhn-plugin
yum-plugin-priorities
deltarpm
openldap-clients
nss-pam-ldapd
authconfig
%end

%pre
$kickstart_start

$SNIPPET('pre_install_network_config')

$SNIPPET('spacewalk/keep_system_id')
%end

%post --nochroot
mkdir /mnt/sysimage/tmp/ks-tree-copy
if [ -d /oldtmp/ks-tree-shadow ]; then
cp -fa /oldtmp/ks-tree-shadow/* /mnt/sysimage/tmp/ks-tree-copy
elif [ -d /tmp/ks-tree-shadow ]; then
cp -fa /tmp/ks-tree-shadow/* /mnt/sysimage/tmp/ks-tree-copy
fi
cp /etc/resolv.conf /mnt/sysimage/etc/resolv.conf
cp -f /tmp/ks-pre.log* /mnt/sysimage/root/ || :

%end

$SNIPPET('spacewalk/post_delete_system')
%end

%post --log /root/ks-rhn-post.log
# --Begin Spacewalk command section--
cat > /tmp/ssl-key-1 <<'EOF'
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            df:7e:8d:60:21:5c:50:bd
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: C=FR, ST=N/A, L=Saint-Pierre en Faucigny, O=LANATHOME, OU=spacewalk.lanathome.com, CN=spacewalk.lanathome.com
        Validity
            Not Before: May 21 08:42:30 2018 GMT
            Not After : May 16 08:42:30 2036 GMT
        Subject: C=FR, ST=N/A, L=Saint-Pierre en Faucigny, O=LANATHOME, OU=spacewalk.lanathome.com, CN=spacewalk.lanathome.com
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    00:b9:ab:90:da:5c:a6:ba:01:b5:71:4a:ce:fe:c6:
                    20:55:af:8a:ba:83:6f:6e:e7:e2:1b:0e:0f:90:f7:
                    c3:19:53:9c:0f:39:83:fd:c5:5f:fd:63:8f:02:8b:
                    43:34:15:69:ea:d3:d4:84:74:d5:92:34:21:c9:fa:
                    45:f4:8a:42:29:e8:ce:b6:3a:3f:fd:18:82:d9:ad:
                    34:23:3f:0a:fd:6a:9b:41:8b:c8:33:2b:0b:29:d5:
                    06:5c:be:e8:3c:fb:4d:3c:92:0f:d9:cf:20:cb:28:
                    7b:1c:d0:10:04:90:71:ac:8d:3c:61:d8:8d:07:6d:
                    5c:55:98:a1:52:3e:3f:7c:cb:e5:ba:f9:06:a3:49:
                    e6:dd:f8:f2:36:65:b9:e9:e2:31:52:d2:15:0a:02:
                    23:ce:39:47:38:d2:75:9e:dc:0a:2d:18:4a:9b:82:
                    07:0a:d5:62:b2:79:8b:31:a9:1d:b2:a1:52:41:d1:
                    d0:76:bc:42:18:84:80:42:9f:24:68:1e:11:d9:83:
                    36:f2:63:6f:7c:fd:f1:42:e9:86:7d:bf:17:b9:14:
                    cb:27:d5:53:20:b3:17:1e:64:cd:d4:f2:63:7c:b1:
                    dd:2f:3a:96:d3:9b:f0:00:2e:f6:61:cd:6e:81:b3:
                    68:7c:88:0c:e6:ec:d0:b8:02:f4:c1:57:e0:db:74:
                    e5:b9
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Basic Constraints: 
                CA:TRUE
            X509v3 Key Usage: 
                Digital Signature, Key Encipherment, Certificate Sign
            X509v3 Extended Key Usage: 
                TLS Web Server Authentication, TLS Web Client Authentication
            Netscape Comment: 
                RHN SSL Tool Generated Certificate
            X509v3 Subject Key Identifier: 
                8A:89:BB:66:D8:8E:23:F7:8B:2C:2A:E2:80:4F:85:64:02:88:AC:08
            X509v3 Authority Key Identifier: 
                keyid:8A:89:BB:66:D8:8E:23:F7:8B:2C:2A:E2:80:4F:85:64:02:88:AC:08
                DirName:/C=FR/ST=N/A/L=Saint-Pierre en Faucigny/O=LANATHOME/OU=spacewalk.lanathome.com/CN=spacewalk.lanathome.com
                serial:DF:7E:8D:60:21:5C:50:BD

    Signature Algorithm: sha256WithRSAEncryption
         24:1b:15:40:be:cf:e3:05:b2:25:a1:3f:76:bd:9b:c6:f8:7a:
         48:52:ac:9b:0c:e3:8c:c7:9a:7e:5d:be:6a:41:72:dc:a9:5f:
         d6:55:a9:73:4c:b6:0c:03:41:7f:6e:14:1b:37:2f:d6:f1:15:
         28:80:03:66:80:48:fb:fe:7e:04:f9:6f:10:c3:2a:d9:1c:ae:
         46:cf:84:72:21:54:1d:4a:2c:22:60:68:6f:18:bb:d8:b4:a5:
         e3:09:6b:58:19:14:43:d2:29:41:92:a1:87:ca:ff:31:89:23:
         d7:32:6d:45:22:e6:0b:98:29:93:c7:5a:be:ab:e1:f4:35:71:
         9d:1d:96:96:a9:25:e1:ea:0f:ab:17:08:9c:74:8d:a1:52:cc:
         65:f5:f0:22:43:bb:78:0e:7b:f7:cc:7d:83:39:8d:34:a7:fe:
         ab:fb:01:cf:59:59:c6:70:3c:fb:e5:1a:b0:fe:d0:07:95:45:
         f0:2b:1e:b9:bf:ac:48:a7:ed:5d:66:c1:3d:55:ad:30:d7:5b:
         04:6f:17:55:ee:22:5a:46:cd:5b:83:7b:1d:27:c6:39:16:dd:
         0a:b7:cb:7f:f7:e6:38:09:a1:88:f9:f4:3d:56:bd:b7:36:cf:
         0e:d9:74:ca:61:f5:51:72:17:97:91:1d:2b:dc:95:d3:6c:2b:
         58:f4:e1:44
-----BEGIN CERTIFICATE-----
MIIFETCCA/mgAwIBAgIJAN9+jWAhXFC9MA0GCSqGSIb3DQEBCwUAMIGWMQswCQYD
VQQGEwJGUjEMMAoGA1UECAwDTi9BMSEwHwYDVQQHDBhTYWludC1QaWVycmUgZW4g
RmF1Y2lnbnkxEjAQBgNVBAoMCUxBTkFUSE9NRTEgMB4GA1UECwwXc3BhY2V3YWxr
LmxhbmF0aG9tZS5jb20xIDAeBgNVBAMMF3NwYWNld2Fsay5sYW5hdGhvbWUuY29t
MB4XDTE4MDUyMTA4NDIzMFoXDTM2MDUxNjA4NDIzMFowgZYxCzAJBgNVBAYTAkZS
MQwwCgYDVQQIDANOL0ExITAfBgNVBAcMGFNhaW50LVBpZXJyZSBlbiBGYXVjaWdu
eTESMBAGA1UECgwJTEFOQVRIT01FMSAwHgYDVQQLDBdzcGFjZXdhbGsubGFuYXRo
b21lLmNvbTEgMB4GA1UEAwwXc3BhY2V3YWxrLmxhbmF0aG9tZS5jb20wggEiMA0G
CSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC5q5DaXKa6AbVxSs7+xiBVr4q6g29u
5+IbDg+Q98MZU5wPOYP9xV/9Y48Ci0M0FWnq09SEdNWSNCHJ+kX0ikIp6M62Oj/9
GILZrTQjPwr9aptBi8gzKwsp1QZcvug8+008kg/ZzyDLKHsc0BAEkHGsjTxh2I0H
bVxVmKFSPj98y+W6+QajSebd+PI2Zbnp4jFS0hUKAiPOOUc40nWe3AotGEqbggcK
1WKyeYsxqR2yoVJB0dB2vEIYhIBCnyRoHhHZgzbyY298/fFC6YZ9vxe5FMsn1VMg
sxceZM3U8mN8sd0vOpbTm/AALvZhzW6Bs2h8iAzm7NC4AvTBV+DbdOW5AgMBAAGj
ggFeMIIBWjAMBgNVHRMEBTADAQH/MAsGA1UdDwQEAwICpDAdBgNVHSUEFjAUBggr
BgEFBQcDAQYIKwYBBQUHAwIwMQYJYIZIAYb4QgENBCQWIlJITiBTU0wgVG9vbCBH
ZW5lcmF0ZWQgQ2VydGlmaWNhdGUwHQYDVR0OBBYEFIqJu2bYjiP3iywq4oBPhWQC
iKwIMIHLBgNVHSMEgcMwgcCAFIqJu2bYjiP3iywq4oBPhWQCiKwIoYGcpIGZMIGW
MQswCQYDVQQGEwJGUjEMMAoGA1UECAwDTi9BMSEwHwYDVQQHDBhTYWludC1QaWVy
cmUgZW4gRmF1Y2lnbnkxEjAQBgNVBAoMCUxBTkFUSE9NRTEgMB4GA1UECwwXc3Bh
Y2V3YWxrLmxhbmF0aG9tZS5jb20xIDAeBgNVBAMMF3NwYWNld2Fsay5sYW5hdGhv
bWUuY29tggkA336NYCFcUL0wDQYJKoZIhvcNAQELBQADggEBACQbFUC+z+MFsiWh
P3a9m8b4ekhSrJsM44zHmn5dvmpBctypX9ZVqXNMtgwDQX9uFBs3L9bxFSiAA2aA
SPv+fgT5bxDDKtkcrkbPhHIhVB1KLCJgaG8Yu9i0peMJa1gZFEPSKUGSoYfK/zGJ
I9cybUUi5guYKZPHWr6r4fQ1cZ0dlpapJeHqD6sXCJx0jaFSzGX18CJDu3gOe/fM
fYM5jTSn/qv7Ac9ZWcZwPPvlGrD+0AeVRfArHrm/rEin7V1mwT1VrTDXWwRvF1Xu
IlpGzVuDex0nxjkW3Qq3y3/35jgJoYj59D1Wvbc2zw7ZdMph9VFyF5eRHSvcldNs
K1j04UQ=
-----END CERTIFICATE-----
EOF
# ssl-key1
cat /tmp/ssl-key-* > /usr/share/rhn/RHN-ORG-TRUSTED-SSL-CERT
perl -pe 's/RHNS-CA-CERT/RHN-ORG-TRUSTED-SSL-CERT/g' -i /etc/sysconfig/rhn/up2date

perl -npe 's|^(\s*(noSSLS\|s)erverURL\s*=\s*[^:]+://)[^/]*/|\${1}$redhat_management_server/|' -i /etc/sysconfig/rhn/up2date
mkdir -p /etc/sysconfig/rhn/allowed-actions/script
touch /etc/sysconfig/rhn/allowed-actions/script/run
mkdir -p /etc/sysconfig/rhn/allowed-actions/configfiles
touch /etc/sysconfig/rhn/allowed-actions/configfiles/all

# now copy from the ks-tree we saved in the non-chroot checkout
cp -fav /tmp/ks-tree-copy/* / 2>/dev/null
rm -Rf /tmp/ks-tree-copy
# --End Spacewalk command section--

# begin cobbler snippet

$SNIPPET('post_install_network_config')
$SNIPPET('spacewalk/default_motd')
$SNIPPET('spacewalk/redhat_register')
# end cobbler snippet

rhn_check
%end


#raw
%post --interpreter /bin/bash
cat <<EOF > /etc/environment
LANG=en_US.utf-8
LC_ALL=en_US.utf-8
EOF
%end
#end raw

#raw
%post --interpreter /bin/bash
 sbin/groupadd --gid 1000001 ansible
/sbin/useradd --uid 1000007 --gid 1000001 --password=$6$xGQVc23nEK6Rw7rp$B1/JXlb/jXDl.I6ov9dmkEjNGNZJqD/4vtCOzJixhyeXonlKzEoJJEBdGNlAWH7sh9aOoRIik0ZfpGDX5TZ6I. -c "Ansible Functional User" -d /home/ansible -m ansible

# Install public key for ansible user
cd /home/ansible
mkdir --mode=700 .ssh
cat >> .ssh/authorized_keys << "PUBLIC_KEY"
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCxUVUILurx5gmAdyJtsfttoLl53duqwlqEez+ZbcRC5Oh3dc4M5OOWxyXwhSy8u5wj/lTuve7xnPgdim6ipPBKbRuHkwzR2myetLmDut4rXkl52Z5Mt9YUtqOHRsLWNSdTcSoAv76g2lWGP/42MghqcJpccNt+JWbwVzZMbj2JWuqm+2YrOU4l2ogEzZe6l1tFtFZcj0k1kbn01vw2gC3D9W0u1dKVw9O0Vy/lajoSvnw1vE9hUbU1v+pkGz0nwpQQkZbAAgK1kVepxtLAKFO5OMvNmTeE3P2NMyaZ7J2ceBv+TgkgnzLRGE1T1oWzIOz1+aHmv+rezRrVTMrvdWz5 ngr@Aureliens-MacBook-Pro
PUBLIC_KEY
chmod 600 .ssh/authorized_keys
chown -R ansible:ansible /home/ansible

# Setup sudoers file for Ansible
cat <<EOF >/etc/sudoers.d/ansible
ansible        ALL=(ALL)       NOPASSWD: ALL
EOF
%end
#end raw

#raw
%post --interpreter /bin/bash
# Install public key for ansible user
cd /home/ansible
mkdir --mode=700 .ssh
cat >> .ssh/authorized_keys << "PUBLIC_KEY"
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCu7KOtTN0T92LjFCq8jBSVSUBUlu2szi1zHKGhsCpa+RNsVXJ3CZvXiqjN4wGcQ7I/Lllu/1fFY41YHXcWBElyFN79nsVZ2zneJ8cODF/z/4wTdrEmcFu2cMCdwjNSwQgi9dbrYeYd6mxbRt39EVPujjHVUmOvX5X/BIsQWcThehNUDNyNzrsz417zB5HBdoANyXVv8bKXqMLuKkt2UrKLRU9vwuQoIDtD06aZIT3wsMayx+HWXoZgLswv0pgBPHKdK4SrUOx4KdUWyfWDDKInzPlTOIW8DEXbF2g24nDEGC8zQJXzSwfnXNX6I9/67a1YS/iqILWpPcJU4+Nez6Tl grosshaa@Aureliens-MacBook-Pro.local
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCxUVUILurx5gmAdyJtsfttoLl53duqwlqEez+ZbcRC5Oh3dc4M5OOWxyXwhSy8u5wj/lTuve7xnPgdim6ipPBKbRuHkwzR2myetLmDut4rXkl52Z5Mt9YUtqOHRsLWNSdTcSoAv76g2lWGP/42MghqcJpccNt+JWbwVzZMbj2JWuqm+2YrOU4l2ogEzZe6l1tFtFZcj0k1kbn01vw2gC3D9W0u1dKVw9O0Vy/lajoSvnw1vE9hUbU1v+pkGz0nwpQQkZbAAgK1kVepxtLAKFO5OMvNmTeE3P2NMyaZ7J2ceBv+TgkgnzLRGE1T1oWzIOz1+aHmv+rezRrVTMrvdWz5 ngr@Aureliens-MacBook-Pro
PUBLIC_KEY
chmod 600 .ssh/authorized_keys
chown -R ansible:ansible /home/ansible
%end
#end raw

#raw
%post --interpreter /bin/bash
yum -y install \
    https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
sed -i -e "s/^enabled=1/enabled=0/" /etc/yum.repos.d/epel.repo

%end
#end raw

##raw
#%post --interpreter /bin/bash
#yum -y --enablerepo=epel install ansible pyOpenSSL
#yum -y install centos-release-openshift-origin39.noarch
#yum -y install origin-node-3.9.0
#yum -y install wget git net-tools bind-utils yum-utils iptables-services bridge-utils bash-completion kexec-tools sos psacct
#yum -y install docker-1.13.1
##end raw
#%end
#
##raw
#%post --interpreter /bin/bash
#cat <<EOF > /etc/sysconfig/docker-storage-setup
#DEVS=/dev/sdb
#VG=docker-vg
#EOF
##end raw
#%end

#raw
%post --interpreter /bin/bash
cat >> /etc/issue << "EOF"
-- WARNING -- This system is for the use of authorized users only. Individuals 
using this computer system without authority or in excess of their authority 
are subject to having all their activities on this system monitored and 
recorded by system personnel. Anyone using this system expressly consents to 
such monitoring and is advised that if such monitoring reveals possible 
evidence of criminal activity system personal may provide the evidence of such 
monitoring to law enforcement officials.
EOF
%end
#end raw

#raw
%post --interpreter /bin/bash
/sbin/authconfig --enableforcelegacy --update
/sbin/authconfig --enableldap --enableldapauth --ldapserver=ldap.lanathome.com --ldapbasedn=dc=ldap,dc=lanathome,dc=com --update
/sbin/authconfig --enablemkhomedir --update
/sbin/authconfig --disableldaptls --update
/sbin/authconfig --enablesssd --update
%end
#end raw

#raw
%post --interpreter /bin/bash
cat >> /etc/sudo-ldap.conf << "EOF"
uri ldap://ldap.lanathome.com:389

sudoers_base ou=SUDOers,dc=ldap,dc=lanathome,dc=com

bind_timelimit 30

timelimit 30
EOF
%end
#end raw

#raw
%post --interpreter /bin/bash
echo "sudoers:    ldap" >> /etc/nsswitch.conf
%end
#end raw

%post$SNIPPET('post_install_kernel_options')
$SNIPPET('koan_environment')

$kickstart_done
%end
